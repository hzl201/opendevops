# 负载均衡
[[toc]]

::: tip
这部分主要是集团平台负载均衡的设置方案。
:::

## 主要目的

**新的要求**：
1. 增强平台的安全性。通过服务器定期杀毒、增加网络跳板机来规范服务器的远程管理。
2. 增强平台的抗压能力。定期检查网络状态，确保网络畅通、web服务和帆软报表实现负载均衡以应对高并发请求。
3. 高稳定性。通过双机热备自动将故障机（web服务、帆软报表、数据库）隔离，无缝切换，以实现服务不中断的目的。

## 准备工作

**硬件准备**
1. 服务器。web服务器2台、帆软报表服务器2台、数据库服务器1台。web服务器上部署web平台，有静态资源和客户上传的文件。帆软报表服务器上部署帆软报表服务。数据库服务器放置主数据库和监测中心库以及其他数据库。
2. 网络。每个服务器设置单独的静态ip，集团和矿端通过vpn互访。
3. 防火墙。集团和矿端都要搭建防火墙，并设置好出入规则。服务器上暂时先关闭防火墙，等测试完毕后再打开防火墙并设置出入站规则。

**软件准备**
1. 集团端平台web已打包。更新到最新的配置和源码、客户上传的文件也已备份。
2. 帆软报表服务已注册。
3. 数据库软件已安装，常用数据库已备份。

## 实施步骤

**外部通知**
- 迁移期间会暂停服务。通知所有部门，如集团科室和矿井科室，确定好更新时间，大概需要2小时。

**内部通知**
- 迁移前开会，确定所有人员的分工，并设置一个项目经理或技术负责人进行整体把控。分工要明确，如部署web单独一人，迁移帆软报表的单独一人，数据库管理单独一人，集团和各矿运维人员都要有单独的负责人。

**web服务迁移**
1. 搭建IIS。创建新的web网站和应用程序池（注意：不要使用已经创建好的应用程序池，有时候会导致集团发文附件无法上传）。两个web的端口尽量都是默认80端口。
2. 注册web服务。
3. 设置共享文件夹。由于要实现负载均衡，客户上传的文件必须在集团的两个web服务器上都能访问到，可设置IIS虚拟目录，使用任意的集团web站点都能上传到同一个目录下（不要使用同步方案，同步文件夹有延迟，而且不稳定）。可由第三台主机设置共享文件夹，两台服务器配置一下base.config，把一些目录指向共享文件夹。需要注意共享盘的访问问题，若a主机和b主机需要访问c主机的共享目录，c主机共享目录要设置为带修改权限才行。![](/Byb271ZUNcVTg83.jpg)
4. 而且重启服务器以后，a和b要重新输入c主机的登录密码才行，可以在a和b主机上这样设置。开始-控制面板-凭据管理器。切换到windows凭据。![](/dmFC8Az1HKOh3ea.jpg)
5. 添加windows凭据，输入ip等登录信息。最后是永久的才行。![](/O5uL9PWhQZYsXrv.jpg)
6. IIS添加虚拟目录。打开“Internet信息服务器管理器”在左侧窗口右击目标站点，选择“添加虚拟目录”。![](/3rFRB2pWVL1U95m.jpg)
![](/8GOtwiNgq21VJcl.jpg)
![](/GyVqHhlP23fmBJ6.jpg)
1. 修改base.config。需要改集团两台web服务器的base.config文件的文件上传路径配置。并把这里设置为两台web的ip，目前还不确定是否改为单独的ip。![](/8NM3A6lFdYehoqx.jpg)
![](/YUqlVJ9NDXErPmM.jpg)
![](/BtK97Myv2FznDlL.jpg)
8. 分别登陆两个web服务器的ip，进行上传和下载测试。如集团收发文，上传后看是否能下载。并且将矿端的web配置文件修改一下，修改App_Data\config\base.config的内容，把ip改为两个服务器的静态ip，查看是否能正常下载收发文附件。矿端的配置还是以负载均衡后的ip为主，如165。  
```
<!--集团系统网址-->
  <add key="JT_WEB_URL" value="http://172.16.0.165"/>
```
1. 搭建负载均衡服务器。这是关于负载均衡的介绍https://www.cnblogs.com/atree/p/windows_loadbalancer.html A主机设一个静态ip若172.16.0.163，B也是静态ip如172.16.0.164，搭建负载均衡后客户访问web时使用网址http://172.16.0.165 。在这里我用的是多播的配置。若需要调整某一个服务器，需要在管理工具-网络负载平衡管理器里选择一个已聚合的主机，右键，控制主机-停止，主机右侧状态会变为“已停止”。这样远程或访问165web时就会只会访问其他主机。等修改完毕以后再“开始”后“继续”。恢复“已聚合”的状态。![](/ZBdvEJGDXwhYr8L.jpg)
![](/JuMaKBoZCTqdne3.jpg)


**帆软报表服务迁移**

1. 安装帆软报表
2. 注册帆软报表服务。
3. 同步帆软报表。由于要实现负载均衡，帆软报表需要同步更新才行，需设置同步软件，执行两个服务器共享文件夹的同步。可由第三台主机设置共享目录，两台服务器把这个共享磁盘映射为本地z盘，把需要同步的文件由本地磁盘同步到z盘。同步周期需要视具体使用情况来定，一般帆软报表更新少，更新周期长，可设为1小时同步一次即可。把同步软件设置为开机自启动。
4. 搭建负载均衡服务器。方法同上。

**数据库迁移**

- 由于本次不对数据库进行任何改动，不需要迁移，而且数据库最好实施方案是双机热备，目前还不成熟，暂不迁移。

## 测试

- 测试web平台能否正常使用，先自测一遍，没有状况就通知所有人员使用。真正使用时可以只设置一台为主，一直是已聚合的状态，另一台做备用，在负载均衡里先停止。等主服务器出现问题后，手动把主服务器设置为停止，备用服务器设置为聚合。等把主服务器的问题排查完以后再恢复。

## 总结

- 帆软报表目前主机出问题后需要手动重启帆软服务，能不能设置为定期重启帆软服务，而且帆软报表服务有时候会过期，能不能有一种有效的自动化监测手段在过期前提醒开发人员？负载均衡能从一定程度上解决帆软报表的高负载问题，但无法解决帆软的高可用性问题。web的负载均衡其实意义不大，因为静态资源不是平台访问速度的瓶颈，而且web负载均衡真的能应对所有突发情况吗？其实数据库的双机热备是刚需，无奈没有测试服务器，无法搭建双机热备。只能说公司的平台还是支持负载均衡的，但是是有条件的，对硬件依赖太大。运维要始终贯穿一个观点：稳即是快。提供安全、稳定、可靠的服务才是运维要做的事情，而且只能尽力减少突发事件造成影响的概率，而不能彻底消除。通过使用监测工具定期对平台进行自检和人工检查结合的方式，可以实现服务器的高可用性。同时也是在践行运维自动化，通过高度的标准化和自动化的运维管理平台，能极大减少运维的工作强度，从刀耕火种的项目实施和维护阶段进化到更高层级的项目管理阶段，临矿项目在这方面是先行者和探索者，通过实践DevOps开发运维一体化的理论，使开发人员和运维人员能更紧密的合作，不断积累经验，将来会探索出一条高可用性方案。
